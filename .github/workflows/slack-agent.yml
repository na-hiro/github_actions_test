name: Japan Market Summary (07:30 JST)

on:
  workflow_dispatch: {}
  schedule:
    # 日本時間 07:30（UTC+9）= 前日 22:30 UTC
    - cron: "30 22 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy-chart:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps for chart
        run: |
          pip install plotly requests pandas

      - name: Generate charts from tickers.csv
        run: |
          mkdir -p public
          python - << 'EOF'
          import csv
          import requests
          import pandas as pd
          import plotly.express as px
          from pathlib import Path

          CFG = Path("tickers.csv")

          tickers = []
          if CFG.exists():
              with CFG.open(encoding="utf-8") as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      t = (row.get("type") or "").strip().lower()
                      sym = (row.get("symbol") or "").strip()
                      label = (row.get("label") or "").strip()
                      if t and sym and label:
                          tickers.append({"type": t, "symbol": sym, "label": label})

          # フォールバック（tickers.csvなし/空）
          if not tickers:
              tickers = [
                  {"type": "index", "symbol": "^NKX", "label": "日経平均"},
                  {"type": "index", "symbol": "^TPX", "label": "TOPIX"},
              ]

          def fetch_stooq_history(symbol: str):
              url = f"https://stooq.com/q/d/l/?s={symbol}&i=d"
              r = requests.get(url, timeout=15)
              r.raise_for_status()
              lines = r.text.strip().splitlines()
              if len(lines) <= 1:
                  raise SystemExit(f"No data for {symbol}")
              reader = csv.DictReader(lines)
              rows = [row for row in reader if row.get("Close")]
              if not rows:
                  raise SystemExit(f"No close data for {symbol}")
              rows.sort(key=lambda x: x["Date"])
              dates = [row["Date"] for row in rows]
              closes = [float(row["Close"]) for row in rows]
              return dates, closes

          # ===== 1) index + gold の総合チャート (index.html) =====
          overview_targets = [t for t in tickers if t["type"] in ("index", "gold")]
          master_df = None

          for t in overview_targets:
              sym = t["symbol"]
              label = t["label"]
              try:
                  dates, closes = fetch_stooq_history(sym)
              except Exception as e:
                  print(f"[WARN] overview {sym}({label}) 取得失敗: {e}")
                  continue

              dates = dates[-120:]
              closes = closes[-120:]
              df = pd.DataFrame({"Date": dates, label: closes})

              if master_df is None:
                  master_df = df
              else:
                  master_df = pd.merge(master_df, df, on="Date", how="inner")

          if master_df is not None and not master_df.empty:
              y_cols = [c for c in master_df.columns if c != "Date"]
              fig = px.line(
                  master_df,
                  x="Date",
                  y=y_cols,
                  title="主要指数・金
